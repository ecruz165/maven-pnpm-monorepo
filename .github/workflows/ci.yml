# =============================================================================
# CI Workflow - Maven Monorepo (Docker-based)
# =============================================================================
# Uses Dockerfile.ci with maven.js CLI for all build operations:
#   init    - Generate package.json from pom.xml
#   status  - Check version alignment
#   sync    - Sync versions between package.json and pom.xml
#   changed - Detect changed modules
#   deps    - Show dependency tree
#   build   - Build with dependency-aware parallel execution
# =============================================================================

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  MAX_PARALLEL: '2'

jobs:
  # ===========================================================================
  # Build & Test (Docker-based)
  # ===========================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Detect changed modules (needs pnpm on host for git operations)
      # -----------------------------------------------------------------------
      - name: Set up Node.js (for change detection)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: 'maven.js changed - Detect changed modules'
        id: changed
        run: |
          CHANGED=$(node scripts/src/maven.js changed --csv 2>/dev/null || echo "")
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT
            echo "No module changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "modules=$CHANGED" >> $GITHUB_OUTPUT
            echo "Changed modules: $CHANGED"
          fi

      - name: 'maven.js deps - Show dependency tree'
        if: steps.changed.outputs.has_changes == 'true'
        run: node scripts/src/maven.js deps

      # -----------------------------------------------------------------------
      # Docker Build: init -> status -> sync -> build (with tests)
      # -----------------------------------------------------------------------
      - name: 'Docker Build - Build & Test changed modules'
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          echo "=== Building with Dockerfile.ci ==="
          echo "Modules: ${{ steps.changed.outputs.modules }}"

          DOCKER_BUILDKIT=1 docker build \
            -f Dockerfile.ci \
            --target build \
            --build-arg MODULES="${{ steps.changed.outputs.modules }}" \
            --build-arg SKIP_TESTS=false \
            --build-arg MAVEN_GOAL=install \
            --build-arg MAX_PARALLEL=${{ env.MAX_PARALLEL }} \
            -t monorepo-build:${{ github.run_number }} \
            .

      - name: Extract build artifacts
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          echo "=== Extracting artifacts from container ==="
          CONTAINER_ID=$(docker create monorepo-build:${{ github.run_number }})

          # Extract JARs and test results from each module
          for MODULE in demo-module-a demo-module-b demo-module-c; do
            mkdir -p $MODULE/target
            docker cp $CONTAINER_ID:/workspace/$MODULE/target/. $MODULE/target/ 2>/dev/null || true
          done

          docker rm $CONTAINER_ID

          # Show extracted artifacts
          echo "=== Extracted JARs ==="
          find . -path "*/target/*.jar" -type f | head -20

          echo "=== Extracted test results ==="
          find . -path "*/target/surefire-reports/*.xml" -type f | head -20

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && steps.changed.outputs.has_changes == 'true'
        with:
          files: |
            **/target/surefire-reports/*.xml

      - name: Upload build artifacts
        if: steps.changed.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/target/*.jar
            !**/target/*-sources.jar
            !**/target/*-javadoc.jar
          retention-days: 7

  # ===========================================================================
  # Version (only on push to main) - Runs on host for git operations
  # ===========================================================================
  version:
    name: Version Modules
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 'maven.js init - Ensure package.json files exist'
        run: node scripts/src/maven.js init

      - name: Version changed modules (changesets)
        id: version
        run: |
          # Apply changesets if any exist
          if [ -d ".changeset" ] && [ "$(ls -A .changeset/*.md 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "Applying changesets..."
            pnpm changeset version

            # Sync Maven versions to match package.json
            node scripts/src/maven.js sync

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No changesets found"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit version changes
        if: steps.version.outputs.updated == 'true'
        run: |
          git add .
          git commit -m "chore: version packages" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

  # ===========================================================================
  # Publish (only on push to main after versioning) - Docker-based
  # ===========================================================================
  publish:
    name: Publish Modules
    runs-on: ubuntu-latest
    needs: [build, version]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest including version commits
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js (for change detection)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: 'maven.js changed - Detect modules to publish'
        id: changed
        run: |
          CHANGED=$(node scripts/src/maven.js changed --csv 2>/dev/null || echo "")
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "modules=$CHANGED" >> $GITHUB_OUTPUT
            echo "Modules to publish: $CHANGED"
          fi

      - name: Create Maven settings for GitHub Packages
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          mkdir -p .m2
          cat > .m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: 'Docker Build - Deploy to GitHub Packages'
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          echo "=== Deploying with Dockerfile.ci ==="
          echo "Modules: ${{ steps.changed.outputs.modules }}"

          DOCKER_BUILDKIT=1 docker build \
            -f Dockerfile.ci \
            --target build \
            --build-arg MODULES="${{ steps.changed.outputs.modules }}" \
            --build-arg SKIP_TESTS=true \
            --build-arg MAVEN_GOAL=deploy \
            --build-arg MAX_PARALLEL=${{ env.MAX_PARALLEL }} \
            --secret id=m2settings,src=.m2/settings.xml \
            -t monorepo-deploy:${{ github.run_number }} \
            .

      - name: Create deployment summary
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          echo "## Published Modules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Modules:** ${{ steps.changed.outputs.modules }}" >> $GITHUB_STEP_SUMMARY
