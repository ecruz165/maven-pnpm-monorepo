# =============================================================================
# CI Workflow - Maven Monorepo
# =============================================================================
# Uses maven.js CLI for all build operations:
#   init    - Generate package.json from pom.xml
#   status  - Check version alignment
#   sync    - Sync versions between package.json and pom.xml
#   changed - Detect changed modules
#   deps    - Show dependency tree
#   build   - Build with dependency-aware parallel execution
# =============================================================================

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'corretto'
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ===========================================================================
  # Build & Test
  # ===========================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      # -----------------------------------------------------------------------
      # maven.js CLI commands
      # -----------------------------------------------------------------------
      - name: 'maven.js init - Generate package.json files'
        run: node scripts/src/maven.js init

      - name: 'maven.js status - Check version alignment'
        run: node scripts/src/maven.js status

      - name: 'maven.js sync - Sync versions'
        run: node scripts/src/maven.js sync --dry-run

      - name: 'maven.js changed - Detect changed modules'
        id: changed
        run: |
          CHANGED=$(node scripts/src/maven.js changed --csv 2>/dev/null || echo "")
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT
            echo "No module changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "modules=$CHANGED" >> $GITHUB_OUTPUT
            echo "Changed modules: $CHANGED"
          fi

      - name: 'maven.js deps - Show dependency tree'
        if: steps.changed.outputs.has_changes == 'true'
        run: node scripts/src/maven.js deps

      - name: 'maven.js build - Build changed modules (with tests)'
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          node scripts/src/maven.js build \
            --modules "${{ steps.changed.outputs.modules }}" \
            --with-tests \
            --max-parallel 2

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && steps.changed.outputs.has_changes == 'true'
        with:
          files: |
            **/target/surefire-reports/*.xml

      - name: Upload build artifacts
        if: steps.changed.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/target/*.jar
            !**/target/*-sources.jar
            !**/target/*-javadoc.jar
          retention-days: 7

  # ===========================================================================
  # Version & Publish (only on push to main)
  # ===========================================================================
  version:
    name: Version Modules
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 'maven.js init - Ensure package.json files exist'
        run: node scripts/src/maven.js init

      - name: Version changed modules (changesets)
        id: version
        run: |
          # Apply changesets if any exist
          if [ -d ".changeset" ] && [ "$(ls -A .changeset/*.md 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "Applying changesets..."
            pnpm changeset version

            # Sync Maven versions to match package.json
            node scripts/src/maven.js sync

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No changesets found"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit version changes
        if: steps.version.outputs.updated == 'true'
        run: |
          git add .
          git commit -m "chore: version packages" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

  # ===========================================================================
  # Publish (only on push to main after versioning)
  # ===========================================================================
  publish:
    name: Publish Modules
    runs-on: ubuntu-latest
    needs: [build, version]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest including version commits

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: 'maven.js changed - Detect modules to publish'
        id: changed
        run: |
          CHANGED=$(node scripts/src/maven.js changed --csv 2>/dev/null || echo "")
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "modules=$CHANGED" >> $GITHUB_OUTPUT
            echo "Modules to publish: $CHANGED"
          fi

      - name: Configure Maven settings
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: 'maven.js build - Build for deployment'
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          node scripts/src/maven.js build \
            --modules "${{ steps.changed.outputs.modules }}" \
            --skip-tests \
            --goal deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          echo "## Published Modules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Modules:** ${{ steps.changed.outputs.modules }}" >> $GITHUB_STEP_SUMMARY

