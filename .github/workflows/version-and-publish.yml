name: Version & Publish Changed Modules

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'corretto'
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      changed-modules: ${{ steps.detect.outputs.modules }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
      modules-json: ${{ steps.detect.outputs.modules-json }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Detect changed modules
        id: detect
        run: |
          # Use our changed-modules script
          CHANGED=$(node scripts/src/changed-modules.js --csv || echo "")

          if [ -z "$CHANGED" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT
            echo "modules-json=[]" >> $GITHUB_OUTPUT
            echo "No modules changed"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "modules=$CHANGED" >> $GITHUB_OUTPUT

            # Convert CSV to JSON array
            MODULES_JSON=$(echo "$CHANGED" | tr ',' '\n' | jq -R . | jq -s .)
            echo "modules-json=$MODULES_JSON" >> $GITHUB_OUTPUT

            echo "Changed modules: $CHANGED"
            echo "Modules JSON: $MODULES_JSON"
          fi

  build-and-test:
    name: Build & Test Changed Modules
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install pnpm dependencies
        run: pnpm install

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build changed modules in parallel
        run: |
          MODULES="${{ needs.detect-changes.outputs.changed-modules }}"
          echo "Building modules in parallel: $MODULES"
          # Use parallel-build.js for faster builds
          node scripts/src/parallel-build.js --modules "$MODULES" --max-parallel 4 --goal install
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test changed modules in parallel
        run: |
          MODULES="${{ needs.detect-changes.outputs.changed-modules }}"
          # Use parallel-build.js for parallel test execution
          node scripts/src/parallel-build.js --modules "$MODULES" --max-parallel 4 --goal test

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/target/surefire-reports/*.xml

  version-modules:
    name: Version Changed Modules
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: |
      needs.detect-changes.outputs.has-changes == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    permissions:
      contents: write
      packages: write
    outputs:
      version-updated: ${{ steps.version.outputs.updated }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Ensure all modules have package.json
        run: pnpm maven:init

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Version changed modules
        id: version
        run: |
          MODULES="${{ needs.detect-changes.outputs.changed-modules }}"
          echo "Versioning modules: $MODULES"

          # Apply changesets (if any exist)
          if [ -d ".changeset" ] && [ "$(ls -A .changeset/*.md 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "Applying changesets..."
            pnpm changeset version

            # Sync Maven versions
            pnpm maven:sync

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No changesets found"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit version changes
        if: steps.version.outputs.updated == 'true'
        run: |
          git add .
          git commit -m "chore: version packages" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

  publish-modules:
    name: Publish Changed Modules
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test, version-modules]
    if: |
      needs.detect-changes.outputs.has-changes == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules-json) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest including version commits

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Publish module to GitHub Packages
        run: |
          echo "Publishing ${{ matrix.module }}..."
          mvn -pl ${{ matrix.module }} -am clean deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        run: |
          echo "## Published: ${{ matrix.module }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get version from package.json
          VERSION=$(cat ${{ matrix.module }}/package.json | jq -r '.version')
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** \`com.example:${{ matrix.module }}:$VERSION-SNAPSHOT\`" >> $GITHUB_STEP_SUMMARY

  create-downstream-prs:
    name: Create Downstream PRs
    runs-on: ubuntu-latest
    needs: [detect-changes, publish-modules]
    if: |
      needs.detect-changes.outputs.has-changes == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Create downstream PRs for changed modules
        run: |
          MODULES="${{ needs.detect-changes.outputs.changed-modules }}"
          echo "Creating downstream PRs for: $MODULES"

          # Run downstream PR script
          pnpm downstream:prs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Downstream PRs Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pull requests created for changed modules" >> $GITHUB_STEP_SUMMARY
          echo "**Modules:** ${{ needs.detect-changes.outputs.changed-modules }}" >> $GITHUB_STEP_SUMMARY
